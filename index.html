<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema POS e Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .tab-inactive { border-color: transparent; color: #6b7280; }
        .tab-content { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-pos" class="px-3 py-2 text-sm font-medium border-b-2 tab-active">Punto de Venta</button>
                <button id="tab-inventory" class="px-3 py-2 text-sm font-medium border-b-2 tab-inactive">Gestionar Inventario</button>
                <button id="tab-sales-query" class="px-3 py-2 text-sm font-medium border-b-2 tab-inactive">Consultar Ventas</button>
            </nav>
        </div>

        <!-- Pestaña: Punto de Venta -->
        <div id="content-pos" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Nueva Venta</h2>
                    <div class="relative mb-4">
                        <label for="search-product" class="block text-sm font-medium text-gray-700 mb-1">Buscar Producto</label>
                        <input type="text" id="search-product" placeholder="Nombre, SKU, Código de Barras..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3">Carrito</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                    <th class="px-4 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="cart-items" class="bg-white divide-y divide-gray-200">
                                <tr id="empty-cart-row"><td colspan="5" class="text-center py-8 text-gray-500">El carrito está vacío</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 h-fit">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Detalles del Cliente</h3>
                    <form id="customer-form" class="space-y-4">
                        <div><label for="customer-name" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="customer-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="customer-contact" class="block text-sm font-medium text-gray-700">Contacto</label><input type="text" id="customer-contact" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="customer-id" class="block text-sm font-medium text-gray-700">NIT/CI</label><input type="text" id="customer-id" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                    </form>
                    <div class="border-t border-gray-200 mt-6 pt-6">
                        <div class="flex justify-between items-center text-2xl font-bold text-gray-800"><span>TOTAL:</span><span id="total-amount">Bs 0.00</span></div>
                        <button id="finalize-sale-button" class="mt-6 w-full inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400"><span id="sale-button-text">Finalizar Venta</span><div id="sale-loader" class="loader hidden ml-3"></div></button>
                        <div class="text-center mt-4 text-sm text-gray-500">Última venta: <span id="last-sale-id" class="font-semibold">N/A</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña: Gestionar Inventario -->
        <div id="content-inventory" class="tab-content">
             <div class="w-full max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8 md:p-12">
                <div class="text-center mb-10">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Registrar Nuevo Producto</h1>
                    <p class="text-gray-500 mt-2">Completa los campos para añadir un artículo al inventario.</p>
                </div>
                <form id="inventory-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label><input type="text" id="nombre" name="nombre" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="sku" class="block text-sm font-medium text-gray-700 mb-1">SKU</label><input type="text" id="sku" name="sku" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label for="precioVenta" class="block text-sm font-medium text-gray-700 mb-1">Precio (Venta)</label><input type="number" step="0.01" id="precioVenta" name="precioVenta" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="precioCompra" class="block text-sm font-medium text-gray-700 mb-1">Precio (Compra)</label><input type="number" step="0.01" id="precioCompra" name="precioCompra" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="precioMayoreo" class="block text-sm font-medium text-gray-700 mb-1">Precio (Mayoreo)</label><input type="number" step="0.01" id="precioMayoreo" name="precioMayoreo" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label><input type="number" id="cantidad" name="cantidad" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="codigoBarras" class="block text-sm font-medium text-gray-700 mb-1">Código de Barras</label><input type="text" id="codigoBarras" name="codigoBarras" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div><label for="urlFoto1" class="block text-sm font-medium text-gray-700 mb-1">URL de la Foto</label><input type="url" id="urlFoto1" placeholder="https://ejemplo.com/imagen.jpg" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" id="inventory-submit-button" class="inline-flex items-center justify-center px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                            <span id="inventory-button-text">Registrar Producto</span>
                            <div id="inventory-loader" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pestaña: Consultar Ventas -->
        <div id="content-sales-query" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Consultar Ventas</h2>
                <input type="text" id="search-sales-input" placeholder="Buscar por Nro. Venta o Nombre del Cliente..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-6">
                <div id="sales-results-container" class="space-y-4">
                    <!-- Los resultados de la búsqueda de ventas se mostrarán aquí -->
                </div>
            </div>
        </div>
        
        <div id="notification" class="fixed top-5 right-5 bg-white shadow-lg rounded-lg p-4 z-50 transition-transform translate-x-full"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxHgB0QiAvw_KA3ple8PlHIcOOcpHjCZfvrhRZB7obM6BDmI30Ff5Ltx1e8mEEERXw/exec';
        
        let products = [];
        let sales = [];
        let cart = [];

        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            fetchProducts();
            
            document.getElementById('search-product').addEventListener('input', handleSearch);
            document.getElementById('search-sales-input').addEventListener('input', renderSalesResults);
            document.getElementById('finalize-sale-button').addEventListener('click', finalizeSale);
            document.getElementById('inventory-form').addEventListener('submit', handleAddProduct);
        });

        function initTabs() {
            const tabs = {
                pos: { btn: document.getElementById('tab-pos'), content: document.getElementById('content-pos') },
                inventory: { btn: document.getElementById('tab-inventory'), content: document.getElementById('content-inventory') },
                salesQuery: { btn: document.getElementById('tab-sales-query'), content: document.getElementById('content-sales-query') }
            };

            Object.keys(tabs).forEach(key => {
                tabs[key].btn.addEventListener('click', () => {
                    Object.values(tabs).forEach(t => {
                        t.btn.classList.remove('tab-active');
                        t.btn.classList.add('tab-inactive');
                        t.content.style.display = 'none';
                    });
                    tabs[key].btn.classList.add('tab-active');
                    tabs[key].btn.classList.remove('tab-inactive');
                    tabs[key].content.style.display = 'block';

                    if (key === 'salesQuery') {
                        fetchSales();
                    }
                });
            });
            tabs.pos.content.style.display = 'block';
        }
        
        async function fetchProducts() {
            showNotification('Cargando productos...', 'info');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: 'getProducts' })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    products = result.data;
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error de red al cargar productos.', 'error');
            }
        }

        async function fetchSales() {
            showNotification('Cargando historial de ventas...', 'info');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: 'getSales' })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    sales = result.data.sort((a, b) => {
                        const numA = parseInt(a['Nro. Venta'].substring(2));
                        const numB = parseInt(b['Nro. Venta'].substring(2));
                        return numB - numA;
                    });
                    renderSalesResults();
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error de red al cargar ventas.', 'error');
            }
        }

        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm.length < 1) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                return;
            }

            const filteredProducts = products.filter(p => 
                p['Nombre']?.toLowerCase().includes(searchTerm) ||
                p['SKU']?.toString().toLowerCase().includes(searchTerm) ||
                p['Código de Barras']?.toString().toLowerCase().includes(searchTerm)
            );

            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            if (filteredProducts.length > 0) {
                filteredProducts.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-gray-100 cursor-pointer';
                    div.textContent = `${p['Nombre']} (Bs ${p['Precio (Venta)']})`;
                    div.onclick = () => addToCart(p);
                    resultsContainer.appendChild(div);
                });
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500">No se encontraron productos</div>';
            }
        }

        function addToCart(product) {
            const existingCartItem = cart.find(item => item['SKU'] === product['SKU'] && item['Nombre'] === product['Nombre']);
            if (existingCartItem) {
                existingCartItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1, customPrice: parseFloat(product['Precio (Venta)']) });
            }
            document.getElementById('search-product').value = '';
            document.getElementById('search-results').classList.add('hidden');
            renderCart();
        }

        function renderCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<tr id="empty-cart-row"><td colspan="5" class="text-center py-8 text-gray-500">El carrito está vacío</td></tr>';
            } else {
                cart.forEach((item, index) => {
                    const subtotal = item.quantity * item.customPrice;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800">${item['Nombre']}</td>
                        <td class="px-4 py-3 text-sm"><input type="number" value="${item.customPrice.toFixed(2)}" onchange="updateItemPrice(${index}, this.value)" class="w-24 text-center border rounded-md py-1"></td>
                        <td class="px-4 py-3 text-sm text-center">
                            <button onclick="updateQuantity(${index}, -1)" class="px-2 font-bold">-</button>
                            ${item.quantity}
                            <button onclick="updateQuantity(${index}, 1)" class="px-2 font-bold">+</button>
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-medium">Bs ${subtotal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center"><button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700">&times;</button></td>
                    `;
                    cartItemsContainer.appendChild(row);
                });
            }
            updateTotal();
        }
        
        function updateItemPrice(index, newPrice) {
            const price = parseFloat(newPrice);
            if (!isNaN(price) && price >= 0) {
                cart[index].customPrice = price;
            }
            renderCart();
        }

        function updateQuantity(index, change) {
            if (cart[index].quantity + change > 0) {
                cart[index].quantity += change;
            } else {
                removeFromCart(index);
            }
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function updateTotal() {
            const total = cart.reduce((sum, item) => sum + (item.quantity * item.customPrice), 0);
            document.getElementById('total-amount').textContent = `Bs ${total.toFixed(2)}`;
            document.getElementById('finalize-sale-button').disabled = cart.length === 0;
        }

        async function finalizeSale() {
            if (cart.length === 0) return;

            const button = document.getElementById('finalize-sale-button');
            const buttonText = document.getElementById('sale-button-text');
            const loader = document.getElementById('sale-loader');

            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');
            button.disabled = true;

            const saleData = {
                action: 'recordSale',
                data: {
                    customer: {
                        name: document.getElementById('customer-name').value,
                        contact: document.getElementById('customer-contact').value,
                        id: document.getElementById('customer-id').value,
                    },
                    items: cart.map(item => ({
                        Nombre: item['Nombre'],
                        SKU: item['SKU'],
                        cantidad: item.quantity,
                        precio: item.customPrice
                    })),
                    total: cart.reduce((sum, item) => sum + (item.quantity * item.customPrice), 0)
                }
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify(saleData)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showNotification(`Venta ${result.saleId} registrada.`, 'success');
                    document.getElementById('last-sale-id').textContent = result.saleId;
                    cart = [];
                    renderCart();
                    document.getElementById('customer-form').reset();
                    fetchProducts();
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error de red al registrar la venta.', 'error');
            } finally {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
                button.disabled = cart.length === 0;
            }
        }

        async function handleAddProduct(e) {
            e.preventDefault();
            const form = document.getElementById('inventory-form');
            const button = document.getElementById('inventory-submit-button');
            const buttonText = document.getElementById('inventory-button-text');
            const loader = document.getElementById('inventory-loader');

            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');
            button.disabled = true;

            const formData = new FormData(form);
            const productData = {};
            formData.forEach((value, key) => { productData[key] = value; });

            const payload = { action: 'addProduct', data: productData };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showNotification(result.message, 'success');
                    form.reset();
                    fetchProducts();
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error de red al añadir producto.', 'error');
            } finally {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
                button.disabled = false;
            }
        }
        
        function renderSalesResults() {
            const searchTerm = document.getElementById('search-sales-input').value.toLowerCase();
            const container = document.getElementById('sales-results-container');
            container.innerHTML = '';

            const filteredSales = sales.filter(s => 
                s['Nro. Venta']?.toLowerCase().includes(searchTerm) ||
                s['Nombre Cliente']?.toLowerCase().includes(searchTerm)
            );

            if (filteredSales.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No se encontraron ventas.</p>';
                return;
            }

            filteredSales.forEach(sale => {
                const isAnnulled = sale['Estado'] === 'Anulada';
                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg ${isAnnulled ? 'bg-gray-200 opacity-70' : 'bg-white'}`;
                
                let productsHtml = '<ul>';
                try {
                    const saleProducts = JSON.parse(sale['Productos Vendidos (JSON)']);
                    saleProducts.forEach(p => {
                        productsHtml += `<li class="text-xs">${p.cantidad} x ${p.Nombre} @ Bs ${p.precio.toFixed(2)}</li>`;
                    });
                } catch(e) { productsHtml += '<li>Error al leer productos</li>'; }
                productsHtml += '</ul>';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">Venta ${sale['Nro. Venta']}</p>
                            <p class="text-sm text-gray-600">${sale['Fecha de Venta']} - ${sale['Nombre Cliente']}</p>
                            <p class="font-semibold text-blue-600">Total: Bs ${parseFloat(sale['Total Venta']).toFixed(2)}</p>
                        </div>
                        <div class="text-right">
                             <span class="font-semibold text-sm px-2 py-1 rounded-full ${isAnnulled ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">${sale['Estado']}</span>
                             <button onclick="confirmAnnulSale('${sale['Nro. Venta']}')" class="mt-2 text-xs bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 disabled:bg-gray-400" ${isAnnulled ? 'disabled' : ''}>Anular</button>
                        </div>
                    </div>
                    <div class="mt-2 text-sm">${productsHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function confirmAnnulSale(saleId) {
            if (confirm(`¿Estás seguro de que quieres anular la venta ${saleId}? Esta acción no se puede deshacer y el stock será restaurado.`)) {
                annulSaleInBackend(saleId);
            }
        }

        async function annulSaleInBackend(saleId) {
            showNotification(`Anulando venta ${saleId}...`, 'info');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: 'annulSale', data: { saleId: saleId } })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showNotification(result.message, 'success');
                    fetchSales();
                    fetchProducts();
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error de red al anular la venta.', 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            
            notification.className = `fixed top-5 right-5 shadow-lg rounded-lg p-4 z-50 transition-transform transform ${bgColor} text-white translate-x-0`;
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
            }, 4000);
        }
    </script>
</body>
</html>
